import{e as a,Q as E,V as m,d as y,M as g,g as T,E as u,h as p,S as f,i as R}from"./index-CqlxQ_W-.js";var r=(i=>(i.CONNECTED="NETWORK_CONNECTED",i.DISCONNECTED="NETWORK_DISCONNECTED",i.CONNECTION_ERROR="NETWORK_CONNECTION_ERROR",i.RECONNECTING="NETWORK_RECONNECTING",i.PLAYER_JOINED="NETWORK_PLAYER_JOINED",i.PLAYER_LEFT="NETWORK_PLAYER_LEFT",i.PLAYER_UPDATED="NETWORK_PLAYER_UPDATED",i.STATE_SYNC="NETWORK_STATE_SYNC",i.OBJECT_CREATED="NETWORK_OBJECT_CREATED",i.OBJECT_UPDATED="NETWORK_OBJECT_UPDATED",i.OBJECT_DELETED="NETWORK_OBJECT_DELETED",i.MESSAGE_RECEIVED="NETWORK_MESSAGE_RECEIVED",i.MESSAGE_SENT="NETWORK_MESSAGE_SENT",i.BROADCAST_RECEIVED="NETWORK_BROADCAST_RECEIVED",i.VOICE_STARTED="NETWORK_VOICE_STARTED",i.VOICE_STOPPED="NETWORK_VOICE_STOPPED",i.VOICE_DATA="NETWORK_VOICE_DATA",i.ROOM_CREATED="NETWORK_ROOM_CREATED",i.ROOM_JOINED="NETWORK_ROOM_JOINED",i.ROOM_LEFT="NETWORK_ROOM_LEFT",i.ROOM_UPDATED="NETWORK_ROOM_UPDATED",i))(r||{});class d{static instance;ws=null;serverUrl="";isConnected=!1;reconnectAttempts=0;MAX_RECONNECT_ATTEMPTS=5;playerId=null;playerName="";currentRoom=null;players=new Map;syncRate=20;syncTimer=null;constructor(){console.log("ðŸŒ Network Manager initialized")}static getInstance(){return d.instance||(d.instance=new d),d.instance}async connect(e,t){return this.serverUrl=e,this.playerName=t,new Promise((s,o)=>{try{this.ws=new WebSocket(e),this.ws.onopen=()=>{console.log("âœ… Connected to server"),this.isConnected=!0,this.reconnectAttempts=0,this.send({type:"handshake",from:this.playerId||"new",data:{playerName:this.playerName},timestamp:Date.now()}),s()},this.ws.onmessage=n=>{this.handleMessage(n.data)},this.ws.onerror=n=>{console.error("âŒ WebSocket error:",n),a.emit(r.CONNECTION_ERROR,{error:new Error("WebSocket connection failed")}),o(n)},this.ws.onclose=()=>{console.log("ðŸ”Œ Disconnected from server"),this.isConnected=!1,this.stopSyncLoop(),a.emit(r.DISCONNECTED,{reason:"Connection closed"}),this.reconnectAttempts<this.MAX_RECONNECT_ATTEMPTS&&this.scheduleReconnect()}}catch(n){console.error("âŒ Failed to connect:",n),o(n)}})}disconnect(){this.ws&&(this.ws.close(),this.ws=null),this.stopSyncLoop(),this.isConnected=!1,this.playerId=null,this.currentRoom=null,this.players.clear(),console.log("ðŸ”Œ Disconnected")}scheduleReconnect(){this.reconnectAttempts++;const e=Math.min(1e3*Math.pow(2,this.reconnectAttempts),3e4);console.log(`ðŸ”„ Reconnecting in ${e}ms (attempt ${this.reconnectAttempts}/${this.MAX_RECONNECT_ATTEMPTS})`),window.setTimeout(()=>{this.connect(this.serverUrl,this.playerName).catch(t=>{console.error("âŒ Reconnect failed:",t)})},e)}handleMessage(e){try{const t=JSON.parse(e);switch(t.type){case"handshake_response":this.playerId=t.data.playerId,console.log(`âœ… Player ID: ${this.playerId}`),a.emit(r.CONNECTED,{playerId:this.playerId,timestamp:Date.now()}),this.startSyncLoop();break;case"player_joined":this.handlePlayerJoined(t.data);break;case"player_left":this.handlePlayerLeft(t.data.playerId);break;case"player_update":this.handlePlayerUpdate(t.data);break;case"state_sync":this.handleStateSync(t.data);break;case"message":this.handleDirectMessage(t);break;case"broadcast":this.handleBroadcast(t);break;default:console.warn("âš ï¸ Unknown message type:",t.type)}}catch(t){console.error("âŒ Error handling message:",t)}}handlePlayerJoined(e){this.players.set(e.id,e),console.log(`ðŸ‘¤ Player joined: ${e.name}`),a.emit(r.PLAYER_JOINED,{playerId:e.id,playerData:e})}handlePlayerLeft(e){const t=this.players.get(e);t&&(this.players.delete(e),console.log(`ðŸ‘¤ Player left: ${t.name}`),a.emit(r.PLAYER_LEFT,{playerId:e}))}handlePlayerUpdate(e){this.players.set(e.id,e),a.emit(r.PLAYER_UPDATED,{playerId:e.id,data:e})}handleStateSync(e){console.log("ðŸ”„ State synced"),a.emit(r.STATE_SYNC,{state:e})}handleDirectMessage(e){console.log(`ðŸ’¬ Message from ${e.from}:`,e.data);const t=e.data;t&&(t.type==="webrtc_offer"||t.type==="webrtc_answer"||t.type==="ice_candidate")?a.emit(r.MESSAGE_RECEIVED,{from:e.from,message:t}):a.emit(r.MESSAGE_RECEIVED,{from:e.from,message:t})}handleBroadcast(e){console.log(`ðŸ“¢ Broadcast from ${e.from}:`,e.data),a.emit(r.BROADCAST_RECEIVED,{from:e.from,message:e.data})}send(e){this.ws&&this.isConnected?this.ws.send(JSON.stringify(e)):console.warn("âš ï¸ Not connected, message not sent")}sendMessage(e,t){this.send({type:"message",from:this.playerId||"",to:e,data:t,timestamp:Date.now()})}broadcast(e){this.send({type:"broadcast",from:this.playerId||"",data:e,timestamp:Date.now()})}syncPlayerState(e,t,s){if(!this.isConnected||!this.playerId)return;const o={id:this.playerId,name:this.playerName,position:e,rotation:t,isVR:s,timestamp:Date.now()};this.send({type:"player_update",from:this.playerId,data:o,timestamp:Date.now()})}startSyncLoop(){this.syncTimer=window.setInterval(()=>{},1e3/this.syncRate)}stopSyncLoop(){this.syncTimer!==null&&(clearInterval(this.syncTimer),this.syncTimer=null)}async createRoom(e){return new Promise((t,s)=>{const o=`room_${Date.now()}`,n=c=>{try{const h=JSON.parse(c.data);h.type==="room_created"&&h.data.roomId===o&&(this.currentRoom=o,this.ws.removeEventListener("message",n),a.emit(r.ROOM_CREATED,{roomId:o,roomData:h.data}),t(o))}catch{}};this.ws?(this.ws.addEventListener("message",n),this.send({type:"create_room",from:this.playerId||"",data:{roomId:o,roomName:e},timestamp:Date.now()}),setTimeout(()=>{this.ws?.removeEventListener("message",n),s(new Error("Room creation timeout"))},5e3)):s(new Error("Not connected"))})}async joinRoom(e){return new Promise((t,s)=>{const o=n=>{try{const c=JSON.parse(n.data);c.type==="room_joined"&&c.data.roomId===e&&(this.currentRoom=e,this.ws.removeEventListener("message",o),a.emit(r.ROOM_JOINED,{roomId:e}),t())}catch{}};this.ws?(this.ws.addEventListener("message",o),this.send({type:"join_room",from:this.playerId||"",data:{roomId:e},timestamp:Date.now()}),setTimeout(()=>{this.ws?.removeEventListener("message",o),s(new Error("Room join timeout"))},5e3)):s(new Error("Not connected"))})}leaveRoom(){this.currentRoom&&(this.send({type:"leave_room",from:this.playerId||"",data:{roomId:this.currentRoom},timestamp:Date.now()}),a.emit(r.ROOM_LEFT,{roomId:this.currentRoom}),this.currentRoom=null)}getIsConnected(){return this.isConnected}getPlayerId(){return this.playerId}getPlayers(){return this.players}getCurrentRoom(){return this.currentRoom}setSyncRate(e){this.syncRate=e,this.syncTimer!==null&&(this.stopSyncLoop(),this.startSyncLoop()),console.log(`ðŸ”„ Sync rate: ${e}Hz`)}}const l=d.getInstance();class O{scene;camera;remotePlayers=new Map;syncedObjects=new Map;localPlayerState={position:new m,rotation:new E,lastSent:0};syncRate=20;interpolationTime=100;enabled=!1;constructor(e,t){this.scene=e,this.camera=t,this.setupNetworkListeners(),console.log("ðŸ”„ Multiplayer Sync initialized")}setupNetworkListeners(){}enable(){this.enabled=!0,console.log("âœ… Multiplayer sync enabled")}disable(){this.enabled=!1,console.log("âŒ Multiplayer sync disabled")}update(e){this.enabled&&(this.syncLocalPlayer(e),this.interpolateRemotePlayers(e),this.syncObjects(e))}syncLocalPlayer(e){const t=Date.now();if(t-this.localPlayerState.lastSent>=1e3/this.syncRate){const o=this.camera.position.clone(),n=this.camera.quaternion.clone();l.syncPlayerState({x:o.x,y:o.y,z:o.z},{x:n.x,y:n.y,z:n.z,w:n.w},!1),this.localPlayerState.position.copy(o),this.localPlayerState.rotation.copy(n),this.localPlayerState.lastSent=t}}interpolateRemotePlayers(e){const t=Date.now();this.remotePlayers.forEach(s=>{const o=t-s.lastUpdate,n=Math.min(o/this.interpolationTime,1);s.mesh.position.lerp(s.targetPosition,n),s.mesh.quaternion.slerp(s.targetRotation,n),o>this.interpolationTime&&s.mesh.position.add(s.velocity.clone().multiplyScalar(e))})}syncObjects(e){}addRemotePlayer(e,t){if(this.remotePlayers.has(e)){console.warn(`âš ï¸ Player ${e} already exists`);return}const s=new y(.3,1.4,4,8),o=new g({color:4474111,roughness:.7,metalness:.3}),n=new T(s,o);n.position.set(t.position.x,t.position.y,t.position.z),n.name=`Player_${e}`,this.scene.add(n);const c=this.createNameTag(t.name||e);c.position.y=2,n.add(c),this.remotePlayers.set(e,{mesh:n,targetPosition:new m(t.position.x,t.position.y,t.position.z),targetRotation:new E(t.rotation.x,t.rotation.y,t.rotation.z,t.rotation.w),lastUpdate:Date.now(),velocity:new m}),console.log(`ðŸ‘¤ Remote player added: ${e}`),a.emit(u.TOOL_ACTIVATED,{toolType:`Multiplayer:PlayerAdded:${e}`})}updateRemotePlayer(e,t){const s=this.remotePlayers.get(e);if(!s){this.addRemotePlayer(e,t);return}const o=Date.now(),n=(o-s.lastUpdate)/1e3,c=new m(t.position.x,t.position.y,t.position.z);n>0&&(s.velocity.subVectors(c,s.targetPosition),s.velocity.divideScalar(n)),s.targetPosition.copy(c),s.targetRotation.set(t.rotation.x,t.rotation.y,t.rotation.z,t.rotation.w),s.lastUpdate=o}removeRemotePlayer(e){const t=this.remotePlayers.get(e);t&&(this.scene.remove(t.mesh),t.mesh.geometry.dispose(),t.mesh.material.dispose(),this.remotePlayers.delete(e),console.log(`ðŸ‘¤ Remote player removed: ${e}`),a.emit(u.TOOL_DEACTIVATED,{toolType:`Multiplayer:PlayerRemoved:${e}`}))}createNameTag(e){const t=document.createElement("canvas"),s=t.getContext("2d");t.width=256,t.height=64,s.fillStyle="rgba(0, 0, 0, 0.7)",s.fillRect(0,0,t.width,t.height),s.font="bold 32px Arial",s.fillStyle="#ffffff",s.textAlign="center",s.textBaseline="middle",s.fillText(e,t.width/2,t.height/2);const o=new p(t),n=new f({map:o}),c=new R(n);return c.scale.set(1,.25,1),c}registerObject(e,t,s){this.syncedObjects.set(e,{object:t,ownerId:s,lastUpdate:Date.now()}),console.log(`ðŸ”„ Object registered for sync: ${e}`)}unregisterObject(e){this.syncedObjects.delete(e),console.log(`ðŸ”„ Object unregistered: ${e}`)}syncObjectTransform(e,t,s,o){const n=this.syncedObjects.get(e);n&&(n.object.position.copy(t),n.object.quaternion.copy(s),n.object.scale.copy(o),n.lastUpdate=Date.now())}setSyncRate(e){this.syncRate=e,l.setSyncRate(e),console.log(`ðŸ”„ Sync rate: ${e}Hz`)}setInterpolationTime(e){this.interpolationTime=e,console.log(`ðŸ”„ Interpolation time: ${e}ms`)}getRemotePlayers(){return this.remotePlayers}clearAll(){this.remotePlayers.forEach((e,t)=>{this.removeRemotePlayer(t)}),this.syncedObjects.clear(),console.log("ðŸ§¹ Multiplayer sync cleared")}getStats(){return{remotePlayers:this.remotePlayers.size,syncedObjects:this.syncedObjects.size,syncRate:this.syncRate,interpolationTime:this.interpolationTime}}printStats(){const e=this.getStats();console.log("ðŸ“Š Multiplayer Sync Stats:"),console.log(`   Remote Players: ${e.remotePlayers}`),console.log(`   Synced Objects: ${e.syncedObjects}`),console.log(`   Sync Rate: ${e.syncRate}Hz`),console.log(`   Interpolation: ${e.interpolationTime}ms`)}}class C{peerConnections=new Map;localStream=null;audioContext=null;gainNode=null;isEnabled=!1;isMuted=!1;isPushToTalk=!0;isTalking=!1;audioConstraints={audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0,sampleRate:48e3},video:!1};constructor(){this.setupAudioContext(),this.setupNetworkListeners(),console.log("ðŸŽ¤ VoIP System initialized")}setupNetworkListeners(){a.on(r.MESSAGE_RECEIVED,e=>{const{from:t,message:s}=e;if(!(!s||typeof s!="object"))switch(s.type){case"webrtc_offer":s.offer&&this.handleOffer(t,s.offer);break;case"webrtc_answer":s.answer&&this.handleAnswer(t,s.answer);break;case"ice_candidate":s.candidate&&this.handleIceCandidate(t,s.candidate);break}}),a.on(r.PLAYER_LEFT,e=>{this.disconnectPeer(e.playerId)})}setupAudioContext(){try{this.audioContext=new(window.AudioContext||window.webkitAudioContext),this.gainNode=this.audioContext.createGain(),this.gainNode.connect(this.audioContext.destination),console.log("âœ… Audio context created")}catch(e){console.error("âŒ Failed to create audio context:",e)}}async enable(){if(this.isEnabled){console.warn("âš ï¸ VoIP already enabled");return}try{this.localStream=await navigator.mediaDevices.getUserMedia(this.audioConstraints),console.log("âœ… Microphone access granted"),this.isEnabled=!0,this.connectToExistingPlayers(),console.log("ðŸŽ¤ VoIP enabled")}catch(e){throw console.error("âŒ Failed to enable VoIP:",e),e}}disable(){if(!this.isEnabled){console.warn("âš ï¸ VoIP already disabled");return}this.localStream&&(this.localStream.getTracks().forEach(e=>e.stop()),this.localStream=null),this.peerConnections.forEach((e,t)=>{this.disconnectPeer(t)}),this.isEnabled=!1,console.log("ðŸŽ¤ VoIP disabled")}connectToExistingPlayers(){l.getPlayers().forEach((t,s)=>{s!==l.getPlayerId()&&this.connectToPeer(s)})}async connectToPeer(e){if(!this.isEnabled||!this.localStream){console.warn("âš ï¸ VoIP not enabled");return}try{const t=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"}]});this.localStream.getTracks().forEach(o=>{t.addTrack(o,this.localStream)}),t.ontrack=o=>{this.handleRemoteStream(e,o.streams[0])},t.onicecandidate=o=>{o.candidate&&l.sendMessage(e,{type:"ice_candidate",candidate:o.candidate})},t.onconnectionstatechange=()=>{console.log(`ðŸ”Œ Connection state (${e}):`,t.connectionState),(t.connectionState==="disconnected"||t.connectionState==="failed")&&this.disconnectPeer(e)};const s=await t.createOffer();await t.setLocalDescription(s),l.sendMessage(e,{type:"webrtc_offer",offer:s}),this.peerConnections.set(e,t),console.log(`ðŸŽ¤ Connected to peer: ${e}`)}catch(t){console.error(`âŒ Failed to connect to peer ${e}:`,t)}}disconnectPeer(e){const t=this.peerConnections.get(e);t&&(t.close(),this.peerConnections.delete(e),console.log(`ðŸŽ¤ Disconnected from peer: ${e}`))}handleRemoteStream(e,t){console.log(`ðŸ”Š Receiving audio from: ${e}`);const s=new Audio;s.srcObject=t,s.autoplay=!0,this.audioContext&&this.gainNode&&this.audioContext.createMediaStreamSource(t).connect(this.gainNode)}async handleOffer(e,t){if(!(!this.isEnabled||!this.localStream))try{const s=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]});this.localStream.getTracks().forEach(n=>{s.addTrack(n,this.localStream)}),s.ontrack=n=>{this.handleRemoteStream(e,n.streams[0])},s.onicecandidate=n=>{n.candidate&&l.sendMessage(e,{type:"ice_candidate",candidate:n.candidate})},await s.setRemoteDescription(new RTCSessionDescription(t));const o=await s.createAnswer();await s.setLocalDescription(o),l.sendMessage(e,{type:"webrtc_answer",answer:o}),this.peerConnections.set(e,s),console.log(`ðŸŽ¤ Answered offer from: ${e}`)}catch(s){console.error(`âŒ Failed to handle offer from ${e}:`,s)}}async handleAnswer(e,t){const s=this.peerConnections.get(e);if(s)try{await s.setRemoteDescription(new RTCSessionDescription(t)),console.log(`ðŸŽ¤ Received answer from: ${e}`)}catch(o){console.error(`âŒ Failed to handle answer from ${e}:`,o)}}async handleIceCandidate(e,t){const s=this.peerConnections.get(e);if(s)try{await s.addIceCandidate(new RTCIceCandidate(t))}catch(o){console.error(`âŒ Failed to add ICE candidate from ${e}:`,o)}}setMuted(e){this.isMuted=e,this.localStream&&this.localStream.getAudioTracks().forEach(t=>{t.enabled=!e}),console.log(`ðŸŽ¤ ${e?"Muted":"Unmuted"}`)}toggleMute(){this.setMuted(!this.isMuted)}pushToTalkPress(){this.isPushToTalk&&!this.isTalking&&(this.isTalking=!0,this.setMuted(!1),console.log("ðŸŽ¤ Push to talk: ON"))}pushToTalkRelease(){this.isPushToTalk&&this.isTalking&&(this.isTalking=!1,this.setMuted(!0),console.log("ðŸŽ¤ Push to talk: OFF"))}setPushToTalk(e){this.isPushToTalk=e,e||this.setMuted(!1),console.log(`ðŸŽ¤ Push to talk: ${e?"enabled":"disabled"}`)}setVolume(e){this.gainNode&&(this.gainNode.gain.value=Math.max(0,Math.min(1,e)),console.log(`ðŸ”Š Volume: ${Math.round(e*100)}%`))}getIsEnabled(){return this.isEnabled}getIsMuted(){return this.isMuted}getStats(){return{enabled:this.isEnabled,muted:this.isMuted,pushToTalk:this.isPushToTalk,connections:this.peerConnections.size}}printStats(){const e=this.getStats();console.log("ðŸ“Š VoIP Stats:"),console.log(`   Enabled: ${e.enabled}`),console.log(`   Muted: ${e.muted}`),console.log(`   Push to Talk: ${e.pushToTalk}`),console.log(`   Active Connections: ${e.connections}`)}}export{O as MultiplayerSync,r as NetworkEventType,d as NetworkManager,C as VoIPSystem,l as networkManager};
