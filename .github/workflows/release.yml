name: ðŸš€ Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., v3.0.0)'
        required: true
        type: string

# Set the AZURE_* repository variables to enable the optional Azure Functions deployment jobs.
env:
  DOTNET_VERSION: '10.0.x'

permissions:
  contents: write
  packages: write

jobs:
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
      version: ${{ steps.get_version.outputs.version }}

    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ðŸ·ï¸ Get version
      id: get_version
      run: |
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          VERSION="${{ github.event.inputs.version }}"
        else
          VERSION=${GITHUB_REF#refs/tags/}
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Version: $VERSION"

    - name: ðŸ“ Generate Release Notes
      id: release_notes
      run: |
        cat > release_notes.md << 'EOF'
        ## ðŸŽ‰ ArxisVR ${{ steps.get_version.outputs.version }}

        ### âœ¨ Highlights
        - ðŸŽ® Intuitive 3D Navigation with orbital camera
        - ðŸ¥½ Full VR Support with teleportation
        - ðŸ¤– AI Assistant powered by Ollama
        - ðŸ“ Visual aids: Grid, Axes, Mini-map, Compass
        - ðŸ’« Rich visual feedback with animations
        - ðŸ“š Interactive 12-step tutorial

        ### ðŸ“¦ Downloads
        Choose your platform below or build from source.

        ### ðŸ“š Documentation
        - [Quick Start Guide](https://github.com/avilaops/ArxisVR2/blob/main/docs/QUICK_START.md)
        - [Complete Documentation](https://github.com/avilaops/ArxisVR2/blob/main/docs/INDEX.md)
        - [AI Setup Guide](https://github.com/avilaops/ArxisVR2/blob/main/AI_README.md)

        ### ðŸ™ Credits
        Developed with â¤ï¸ by [NÃ­colas Ãvila](https://github.com/avilaops)
        EOF
        cat release_notes.md

    - name: ðŸš€ Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.get_version.outputs.version }}
        release_name: ArxisVR ${{ steps.get_version.outputs.version }}
        body_path: release_notes.md
        draft: false
        prerelease: false

  build-and-upload:
    name: Build ${{ matrix.config.name }}
    needs: create-release
    runs-on: ${{ matrix.config.os }}
    strategy:
      fail-fast: false
      matrix:
        config:
          - name: Windows
            os: windows-latest
            artifact: ArxisVR-windows-x64.zip
            build_script: |
              dotnet publish -c Release -r win-x64 --self-contained false -o publish/windows
              Compress-Archive -Path publish/windows/* -DestinationPath ArxisVR-windows-x64.zip

          - name: Linux
            os: ubuntu-latest
            artifact: ArxisVR-linux-x64.tar.gz
            build_script: |
              dotnet publish -c Release -r linux-x64 --self-contained false -o publish/linux
              tar -czf ArxisVR-linux-x64.tar.gz -C publish/linux .

          - name: macOS
            os: macos-latest
            artifact: ArxisVR-macos-x64.zip
            build_script: |
              dotnet publish -c Release -r osx-x64 --self-contained false -o publish/macos
              cd publish/macos && zip -r ../../ArxisVR-macos-x64.zip . && cd ../..

    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ”§ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: ðŸ“¦ Restore dependencies
      run: dotnet restore

    - name: ðŸ—ï¸ Build and Package
      shell: bash
      run: ${{ matrix.config.build_script }}

    - name: ðŸ“¤ Upload Release Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ needs.create-release.outputs.upload_url }}
        asset_path: ./${{ matrix.config.artifact }}
        asset_name: ${{ matrix.config.artifact }}
        asset_content_type: application/octet-stream

    - name: âœ… Build Complete
      run: |
        echo "### âœ… ${{ matrix.config.name }} Build Complete" >> $GITHUB_STEP_SUMMARY
        echo "Artifact: ${{ matrix.config.artifact }}" >> $GITHUB_STEP_SUMMARY

  package-function-app:
    name: ðŸ“¦ Package Azure Function
    needs: create-release
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      FUNCTIONAPP_BUILD_ROOT: build/functionapp
      FUNCTIONAPP_PACKAGE_FILE: functionapp.zip
      FUNCTIONAPP_ARTIFACT_NAME: functionapp-package
    outputs:
      artifact-name: ${{ steps.package_metadata.outputs.artifact-name }}
      package-file: ${{ steps.package_metadata.outputs.package-file }}
      project-found: ${{ steps.resolve_function.outputs.found }}

    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ”§ Setup .NET for Functions
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: ðŸ” Resolve Function project
      id: resolve_function
      shell: bash
      run: |
        PROJECT_PATH="${AZURE_FUNCTIONAPP_PROJECT:-}"
        if [ -z "$PROJECT_PATH" ]; then
          PROJECT_PATH=$(find . -maxdepth 5 -name '*.csproj' -print0 | xargs -0 grep -l 'Microsoft.NET.Sdk.Functions' | head -n 1 || true)
        fi

        if [ -n "$PROJECT_PATH" ] && [ -f "$PROJECT_PATH" ]; then
          echo "found=true" >> $GITHUB_OUTPUT
          echo "project=$PROJECT_PATH" >> $GITHUB_OUTPUT
          echo "Resolved Azure Functions project: $PROJECT_PATH"
        else
          echo "found=false" >> $GITHUB_OUTPUT
          echo "project=" >> $GITHUB_OUTPUT
          echo "No Azure Functions project detected. Skipping package." >> $GITHUB_STEP_SUMMARY
        fi

    - name: ðŸ“¦ Restore Function dependencies
      if: ${{ steps.resolve_function.outputs.found == 'true' }}
      run: dotnet restore "${{ steps.resolve_function.outputs.project }}"

    - name: ðŸ—ï¸ Publish Function app
      if: ${{ steps.resolve_function.outputs.found == 'true' }}
      run: |
        mkdir -p "$GITHUB_WORKSPACE/$FUNCTIONAPP_BUILD_ROOT/publish"
        dotnet publish "${{ steps.resolve_function.outputs.project }}" --configuration Release --output "$GITHUB_WORKSPACE/$FUNCTIONAPP_BUILD_ROOT/publish"

    - name: ðŸ—œï¸ Archive Function package
      if: ${{ steps.resolve_function.outputs.found == 'true' }}
      run: |
        rm -f "$GITHUB_WORKSPACE/$FUNCTIONAPP_BUILD_ROOT/$FUNCTIONAPP_PACKAGE_FILE"
        cd "$GITHUB_WORKSPACE/$FUNCTIONAPP_BUILD_ROOT/publish"
        zip -r "$GITHUB_WORKSPACE/$FUNCTIONAPP_BUILD_ROOT/$FUNCTIONAPP_PACKAGE_FILE" .

    - name: ðŸ“¡ Upload Function package artifact
      if: ${{ steps.resolve_function.outputs.found == 'true' }}
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.FUNCTIONAPP_ARTIFACT_NAME }}
        path: ${{ env.FUNCTIONAPP_BUILD_ROOT }}/${{ env.FUNCTIONAPP_PACKAGE_FILE }}

    - name: ðŸ—’ï¸ Function package summary
      if: ${{ steps.resolve_function.outputs.found == 'true' }}
      run: |
        echo "### ðŸ“¦ Azure Function package ready" >> $GITHUB_STEP_SUMMARY
        echo "Artifact: $FUNCTIONAPP_ARTIFACT_NAME" >> $GITHUB_STEP_SUMMARY
        echo "Package file: $FUNCTIONAPP_PACKAGE_FILE" >> $GITHUB_STEP_SUMMARY

    - name: ðŸ”– Capture package metadata
      if: ${{ steps.resolve_function.outputs.found == 'true' }}
      id: package_metadata
      run: |
        echo "artifact-name=$FUNCTIONAPP_ARTIFACT_NAME" >> $GITHUB_OUTPUT
        echo "package-file=$FUNCTIONAPP_PACKAGE_FILE" >> $GITHUB_OUTPUT

  deploy-function-app:
    name: ðŸš€ Deploy Azure Function
    needs: package-function-app
    if: ${{ needs.package-function-app.result == 'success' && needs.package-function-app.outputs['project-found'] == 'true' }}
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    env:
      FUNCTIONAPP_ARTIFACT_NAME: ${{ needs.package-function-app.outputs['artifact-name'] }}
      FUNCTIONAPP_PACKAGE_FILE: ${{ needs.package-function-app.outputs['package-file'] }}
    outputs:
      deployment-started: ${{ steps.validate_azure.outputs.deploy }}

    steps:
    - name: ðŸ” Validate Azure credentials
      id: validate_azure
      shell: bash
      run: |
        missing=0
        for var in AZURE_FUNCTIONAPP_NAME AZURE_CLIENT_ID AZURE_TENANT_ID AZURE_SUBSCRIPTION_ID; do
          value="${!var}"
          if [ -z "$value" ]; then
            echo "Missing $var" >> $GITHUB_STEP_SUMMARY
            missing=$((missing+1))
          else
            printf '%s=%s\n' "$var" "$value" >> "$GITHUB_ENV"
          fi
        done

        if [ $missing -gt 0 ]; then
          echo "deploy=false" >> $GITHUB_OUTPUT
          echo "âš ï¸ Azure Function deployment skipped: configure AZURE_* secrets." >> $GITHUB_STEP_SUMMARY
        else
          echo "deploy=true" >> $GITHUB_OUTPUT
          printf 'client-id=%s\n' "$AZURE_CLIENT_ID" >> "$GITHUB_OUTPUT"
          printf 'tenant-id=%s\n' "$AZURE_TENANT_ID" >> "$GITHUB_OUTPUT"
          printf 'subscription-id=%s\n' "$AZURE_SUBSCRIPTION_ID" >> "$GITHUB_OUTPUT"
          printf 'function-app=%s\n' "$AZURE_FUNCTIONAPP_NAME" >> "$GITHUB_OUTPUT"
        fi

    - name: ðŸ“¥ Download Function package
      if: ${{ steps.validate_azure.outputs.deploy == 'true' }}
      uses: actions/download-artifact@v4
      with:
        name: ${{ env.FUNCTIONAPP_ARTIFACT_NAME }}
        path: functionapp-package

    - name: ðŸ” Log in to Azure (OIDC)
      if: ${{ steps.validate_azure.outputs.deploy == 'true' }}
      uses: azure/login@v2
      with:
        client-id: ${{ steps.validate_azure.outputs.client-id }}
        tenant-id: ${{ steps.validate_azure.outputs.tenant-id }}
        subscription-id: ${{ steps.validate_azure.outputs.subscription-id }}

    - name: ðŸŒ Deploy package to Azure Functions
      if: ${{ steps.validate_azure.outputs.deploy == 'true' }}
      uses: Azure/functions-action@v1
      with:
        app-name: ${{ steps.validate_azure.outputs['function-app'] }}
        package: functionapp-package/${{ env.FUNCTIONAPP_PACKAGE_FILE }}
        respect-funcignore: true

    - name: âœ… Deployment summary
      if: ${{ steps.validate_azure.outputs.deploy == 'true' }}
      run: |
        echo "### âœ… Azure Function deployment completed" >> $GITHUB_STEP_SUMMARY
        echo "App: $AZURE_FUNCTIONAPP_NAME" >> $GITHUB_STEP_SUMMARY

  notify:
    name: ðŸ“¢ Notify Release
    needs:
      - create-release
      - build-and-upload
      - package-function-app
      - deploy-function-app
    runs-on: ubuntu-latest
    steps:
    - name: ðŸŽ‰ Release Complete
      run: |
        echo "### ðŸŽ‰ Release ${{ needs.create-release.outputs.version }} Complete!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Windows build uploaded" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Linux build uploaded" >> $GITHUB_STEP_SUMMARY
        echo "âœ… macOS build uploaded" >> $GITHUB_STEP_SUMMARY

        if [ "${{ needs.package-function-app.result }}" = "skipped" ]; then
          echo "â„¹ï¸ Azure Function packaging job skipped" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ needs.package-function-app.outputs['project-found'] }}" = "true" ]; then
          echo "âœ… Azure Function package created" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ needs.package-function-app.outputs['project-found'] }}" = "false" ]; then
          echo "â„¹ï¸ Azure Function packaging skipped (no Functions project detected)" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ Azure Function packaging encountered an issue" >> $GITHUB_STEP_SUMMARY
        fi

        if [ "${{ needs.deploy-function-app.result }}" = "skipped" ]; then
          echo "â„¹ï¸ Azure Function deployment job skipped" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ needs.deploy-function-app.outputs['deployment-started'] }}" = "true" ]; then
          echo "âœ… Azure Function deployment updated" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ needs.deploy-function-app.outputs['deployment-started'] }}" = "false" ]; then
          echo "â„¹ï¸ Azure Function deployment skipped (configure AZURE_* secrets for OIDC)" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ Azure Function deployment encountered an issue" >> $GITHUB_STEP_SUMMARY
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ”— [View Release](https://github.com/${{ github.repository }}/releases/tag/${{ needs.create-release.outputs.version }})" >> $GITHUB_STEP_SUMMARY
