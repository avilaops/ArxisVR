name: ðŸš€ Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., v3.0.0)'
        required: true
        type: string

env:
  DOTNET_VERSION: '10.0.x'

permissions:
  contents: write
  packages: write

jobs:
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
      version: ${{ steps.get_version.outputs.version }}
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ðŸ·ï¸ Get version
      id: get_version
      run: |
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          VERSION="${{ github.event.inputs.version }}"
        else
          VERSION=${GITHUB_REF#refs/tags/}
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Version: $VERSION"
    
    - name: ðŸ“ Generate Release Notes
      id: release_notes
      run: |
        cat > release_notes.md << 'EOF'
        ## ðŸŽ‰ Vizzio ${{ steps.get_version.outputs.version }}
        
        ### âœ¨ Highlights
        - ðŸŽ® Intuitive 3D Navigation with orbital camera
        - ðŸ¥½ Full VR Support with teleportation
        - ðŸ¤– AI Assistant powered by Ollama
        - ðŸ“ Visual aids: Grid, Axes, Mini-map, Compass
        - ðŸ’« Rich visual feedback with animations
        - ðŸ“š Interactive 12-step tutorial
        
        ### ðŸ“¦ Downloads
        Choose your platform below or build from source.
        
        ### ðŸ“š Documentation
        - [Quick Start Guide](https://github.com/avilaops/vizzio2/blob/main/docs/QUICK_START.md)
        - [Complete Documentation](https://github.com/avilaops/vizzio2/blob/main/docs/INDEX.md)
        - [AI Setup Guide](https://github.com/avilaops/vizzio2/blob/main/AI_README.md)
        
        ### ðŸ™ Credits
        Developed with â¤ï¸ by [NÃ­colas Ãvila](https://github.com/avilaops)
        EOF
        cat release_notes.md
    
    - name: ðŸš€ Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.get_version.outputs.version }}
        release_name: Vizzio ${{ steps.get_version.outputs.version }}
        body_path: release_notes.md
        draft: false
        prerelease: false

  build-and-upload:
    name: Build ${{ matrix.config.name }}
    needs: create-release
    runs-on: ${{ matrix.config.os }}
    strategy:
      fail-fast: false
      matrix:
        config:
          - name: Windows
            os: windows-latest
            artifact: vizzio-windows-x64.zip
            build_script: |
              dotnet publish -c Release -r win-x64 --self-contained false -o publish/windows
              Compress-Archive -Path publish/windows/* -DestinationPath vizzio-windows-x64.zip
          
          - name: Linux
            os: ubuntu-latest
            artifact: vizzio-linux-x64.tar.gz
            build_script: |
              dotnet publish -c Release -r linux-x64 --self-contained false -o publish/linux
              tar -czf vizzio-linux-x64.tar.gz -C publish/linux .
          
          - name: macOS
            os: macos-latest
            artifact: vizzio-macos-x64.zip
            build_script: |
              dotnet publish -c Release -r osx-x64 --self-contained false -o publish/macos
              cd publish/macos && zip -r ../../vizzio-macos-x64.zip . && cd ../..
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ðŸ”§ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    - name: ðŸ“¦ Restore dependencies
      run: dotnet restore
    
    - name: ðŸ—ï¸ Build and Package
      shell: bash
      run: ${{ matrix.config.build_script }}
    
    - name: ðŸ“¤ Upload Release Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ needs.create-release.outputs.upload_url }}
        asset_path: ./${{ matrix.config.artifact }}
        asset_name: ${{ matrix.config.artifact }}
        asset_content_type: application/octet-stream
    
    - name: âœ… Build Complete
      run: |
        echo "### âœ… ${{ matrix.config.name }} Build Complete" >> $GITHUB_STEP_SUMMARY
        echo "Artifact: ${{ matrix.config.artifact }}" >> $GITHUB_STEP_SUMMARY

  notify:
    name: ðŸ“¢ Notify Release
    needs: [create-release, build-and-upload]
    runs-on: ubuntu-latest
    steps:
    - name: ðŸŽ‰ Release Complete
      run: |
        echo "### ðŸŽ‰ Release ${{ needs.create-release.outputs.version }} Complete!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Windows build uploaded" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Linux build uploaded" >> $GITHUB_STEP_SUMMARY
        echo "âœ… macOS build uploaded" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ”— [View Release](https://github.com/${{ github.repository }}/releases/tag/${{ needs.create-release.outputs.version }})" >> $GITHUB_STEP_SUMMARY
